<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ—¥æœ¬ã®ç”Ÿæ´»(ä»®)</title>
<style>
  body { font-family: sans-serif; background: #FFEFD5; text-align: center; padding: 10px 5px;   
position: relative;  }
 .category-btn {
  padding: 14px 20px;
  font-size: 1.2em;
  margin: 10px auto;
  width: 92vw;
  max-width: 340px;
  background-color: orange;
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  white-space: pre-line; /* æ”¹è¡Œè¨±å¯ */
  display: block;
  box-sizing: border-box;
  line-height: 1.4;
  text-align: center;
}
  body.darken-background {
    background-color: #2b2b2b !important;
    background-image:
    repeating-linear-gradient(45deg, rgba(255,255,255,0.015) 0, rgba(255,255,255,0.015) 1px, transparent 1px, transparent 5px),
    repeating-linear-gradient(-45deg, rgba(255,255,255,0.015) 0, rgba(255,255,255,0.015) 1px, transparent 1px, transparent 5px);
  color: white !important;
}
  .category-title {
  background-color: orange;
  color: white;
  padding: 8px 16px;
  border-radius: 12px;
  display: inline-block;
  line-height: 1.3;
  white-space: pre-line; /* æ”¹è¡Œã‚’æœ‰åŠ¹ã« */
  margin-bottom: 12px;
  user-select: none;
}
  .choice {
  display: block;
  margin: 8px auto;
  padding: 14px 16px;
  padding-right: 40px; /* â† ã“ã“ã‚’è¿½åŠ  */
  font-size: 1.2em;
  max-width: 90vw;
  background-color: #ADD8E6;
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  white-space: pre-wrap;
  text-align: left;
  word-break: break-word;
  box-sizing: border-box;
  text-indent: 0;
}
  .choice.disabled:hover,
  .choice.disabled:active {
    background-color: #ADD8E6 !important;
  }

  .chosen { background-color: #87b4cc; }
  .disabled { pointer-events: none; }
  .mark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2em;
    font-weight: bold;
    color: red;
    user-select: none;
    pointer-events: none;
  }
  .speaker-icon {
    cursor: pointer;
    font-size: 1.5em;
    color: #444;
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    user-select: none;
    pointer-events: auto;
  }
  .explanation {
    margin-top: 20px;
    white-space: pre-wrap;
    color: #444;
    text-align: left;
    max-width: 90vw;
    margin-left: auto;
    margin-right: auto;
  }
#container {
  position: relative;       /* timerã‚’åŸºæº–ã«ã™ã‚‹ãŸã‚ */
  padding-bottom: 80px;     /* ä¸‹ã«ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ */
}
body {
  position: relative; /* timerã®åŸºæº– */
}
#timer {
  position: absolute;  
  top: 10px;
  right: 10px;
  font-size: 1em;
  background: rgba(255,255,255,0.85);
  padding: 6px 10px;
  border-radius: 8px;
  z-index: 1000;
}
  @keyframes fall {
    0% { transform: translateY(-50px) rotate(0deg); opacity: 0.8; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
  }
  .sakura {
    position: fixed;
    top: -50px;
    font-size: 24px;
    pointer-events: none;
    color: pink;
    animation: fall linear 12s;
    z-index: 9999;
    user-select: none;
  }
</style>
</head>
<body>
<h1 id="main-title">æ—¥æœ¬ã®ç”Ÿæ´»(ä»®)</h1>
<div id="start-buttons"></div>
<div id="container"></div>
<div id="timer">æ™‚é–“: 0ç§’</div>

<script>
// JSONãƒ‡ãƒ¼ã‚¿ã¯ã“ã“ã«Pythonã‹ã‚‰å·®ã—è¾¼ã¿ã¾ã™
let audioPlaying = null;
const allQuestions = JSON.parse(`{questions_json}`);
const audioData = JSON.parse(`{audio_json}`);

let currentCategory = null;
let questions = [];
let currentIndex = 0;
let score = 0;
let startTime = null;
let timerInterval = null;
let answered = false;

function createButton(text, onClick) {
  const btn = document.createElement('button');
  btn.textContent = text;
  btn.className = 'category-btn';
  btn.onclick = onClick;
  return btn;
}

function showCategories() {
  document.body.classList.remove('darken-background');
  const container = document.getElementById('start-buttons');
  container.style.display = 'block';
  container.innerHTML = '';
  
  const title = document.getElementById('main-title');
  title.textContent = 'æ—¥æœ¬ã®ç”Ÿæ´»(ä»®)';

  for (const category in allQuestions) {
    const count = allQuestions[category].length;
  const [jp, th] = category.split('\n');
  const btnText = `${jp}ï¼ˆ${count}å•ï¼‰\n${th}`;
  const btn = createButton(btnText, () => startQuiz(category));
  container.appendChild(btn);
}
  document.getElementById('container').innerHTML = '';
  document.getElementById('timer').textContent = 'æ™‚é–“: 0ç§’';
}

function startTimer() {
  startTime = Date.now();
  timerInterval = setInterval(() => {
    const timerEl = document.getElementById('timer');
    if (!timerEl) {
      console.warn('âš ï¸ #timer è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return;
    }
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    timerEl.textContent = 'æ™‚é–“: ' + elapsed + 'ç§’';
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
}

function startQuiz(category) {
  currentCategory = category;
  questions = allQuestions[category];
  questions = questions.slice(0, 2);
  currentIndex = 0;
  score = 0;
  const [jp, th] = category.split('\n');
  const title = document.getElementById('main-title');
  title.innerHTML = `${jp}<br>${th}`; 
  title.classList.add('category-title');    document.getElementById('start-buttons').style.display = 'none';
  showQuestion();
  startTimer();
}

function showQuestion() {
  answered = false;
  if (audioPlaying) {
    audioPlaying.pause();
    audioPlaying.currentTime = 0;
    audioPlaying = null;
  }
  
  answered = false;
  const q = questions[currentIndex];
  const container = document.getElementById('container');
  container.innerHTML = '';

  const progress = document.createElement('div');
  progress.textContent = `${currentIndex + 1} / ${questions.length}`;
  progress.style.fontWeight = 'bold';
  progress.style.textAlign = 'left';
  progress.style.marginBottom = '10px';
  container.appendChild(progress);

  const qElem = document.createElement('div');
  const highlighted = q.question
    .replace(/ï¼ˆæ­£ç­”\dã¤ï¼‰/g, m => `<span style="color:red;">${m}</span>`)
    .replace(/[ï¼ˆ(]à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\dà¸‚à¹‰à¸­[)ï¼‰]/g, m => `<span style="color:red;">${m}</span>`);
  qElem.innerHTML = highlighted;
  qElem.style.whiteSpace = 'pre-wrap';
  qElem.style.fontWeight = 'bold';
  qElem.style.fontSize = '1.2em';
  qElem.style.textAlign = 'left';
  container.appendChild(qElem);

   let selectedChoices = [];

  q.choices.forEach(choice => {
    const choiceDiv = document.createElement('div');
    choiceDiv.className = 'choice';
    choiceDiv.textContent = choice;
    choiceDiv.style.textAlign = 'left';

    choiceDiv.onclick = () => {
      if (answered) return;  // åˆ¤å®šæ¸ˆã¿ãªã‚‰ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹

      const alreadySelected = selectedChoices.includes(choice);

      if (alreadySelected) {
        selectedChoices = selectedChoices.filter(c => c !== choice);
        choiceDiv.classList.remove('chosen');
      } else {
        selectedChoices.push(choice);
        choiceDiv.classList.add('chosen');
      }

      if (selectedChoices.length === q.correct.length) {
        answered = true;   // æ­£èª¤åˆ¤å®šãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
        container.classList.add('disabled');  // å¿…è¦ã«å¿œã˜ã¦

    container.querySelectorAll('.choice').forEach(choiceDiv => {
       choiceDiv.style.cursor = 'default';  // é¸æŠè‚¢ã¯ãƒã‚¤ãƒ³ã‚¿è§£é™¤
     });

     container.querySelectorAll('.speaker-icon').forEach(speaker => {
       speaker.style.cursor = 'pointer'; 
     });
        let isAllCorrect = true;

        selectedChoices.forEach(sel => {
          const choiceElement = Array.from(container.getElementsByClassName('choice'))
            .find(div => div.textContent === sel);

          if (!choiceElement) return;

          const isCorrect = q.correct.includes(sel);
          if (!isCorrect) isAllCorrect = false;

          markChoice(choiceElement, isCorrect);

      if (isCorrect) {
        const correctIndex = q.correct.indexOf(sel) + 1;
        const numberStr = String(q.number).padStart(2, '0');
        const audioFileName = `${q.categoryNo}-${numberStr}-${correctIndex}.mp3`;
        const audioSrc = audioData[audioFileName];
        if (audioSrc) {
          const speaker = document.createElement('span');
          speaker.className = 'speaker-icon';
          speaker.innerHTML = 'ğŸ”Š';
          speaker.onclick = e => {
            e.stopPropagation();
            if (audioPlaying) {
              audioPlaying.pause();
              audioPlaying.currentTime = 0;
            }
            const audio = new Audio(audioSrc);
            audio.playbackRate = 1.3;
            audio.play();
            audioPlaying = audio;
            audio.onended = () => {
              audioPlaying = null;
            };
          };
          choiceElement.appendChild(speaker);
        }
      }
    });

    // æ­£è§£ã ãŒæœªé¸æŠã®é¸æŠè‚¢ã«ã‚‚è‰²ã¨ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
    q.correct.forEach(correctAns => {
          if (!selectedChoices.includes(correctAns)) {
            const choiceElement = Array.from(container.getElementsByClassName('choice'))
              .find(div => div.textContent === correctAns);
            if (choiceElement) {
              choiceElement.style.backgroundColor = '#ffccff';
          const correctIndex = q.correct.indexOf(correctAns) + 1;
          const numberStr = String(q.number).padStart(2, '0');
          const audioFileName = `${q.categoryNo}-${numberStr}-${correctIndex}.mp3`;
          const audioSrc = audioData[audioFileName];
          if (audioSrc) {
            const speaker = document.createElement('span');
            speaker.className = 'speaker-icon';
            speaker.innerHTML = 'ğŸ”Š';
            speaker.onclick = e => {
              e.stopPropagation();
              if (audioPlaying) {
                audioPlaying.pause();
                audioPlaying.currentTime = 0;
              }
              const audio = new Audio(audioSrc);
              audio.playbackRate = 1.3;
              audio.play();
              audioPlaying = audio;
              audio.onended = () => {
                audioPlaying = null;
              };
            };
            choiceElement.appendChild(speaker);
          }
        }
      }
    });

    // ã‚¹ã‚³ã‚¢åŠ ç®—
    if (isAllCorrect) {
      score++;
    }

    showExplanation();
  }
};


    container.appendChild(choiceDiv);
  });
}

function markChoice(choiceDiv, isCorrect) {
  const mark = document.createElement('span');
  mark.className = 'mark';
  mark.textContent = isCorrect ? 'ã€‡' : 'Ã—';
  choiceDiv.appendChild(mark);
}

function showExplanation() {
  const container = document.getElementById('container');
  const q = questions[currentIndex];

  // è§£èª¬è¡¨ç¤º
  const explanationDiv = document.createElement('div');
  explanationDiv.className = 'explanation';
  explanationDiv.textContent = q.explanation || 'è§£èª¬ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
  container.appendChild(explanationDiv);

  const existingNextBtn = container.querySelector('.next-btn');
  if (existingNextBtn) {
    existingNextBtn.remove();
  }
  const nextBtn = createButton('æ¬¡ã¸', () => {
    currentIndex++;
    if (currentIndex < questions.length) {
      showQuestion();
    } else {
      showResult();
    }
  });
  nextBtn.classList.add('next-btn'); 
  container.appendChild(nextBtn);

  // ã“ã“ã§ .disabled ã‚¯ãƒ©ã‚¹ã‚’å¤–ã™
  container.classList.remove('disabled');
}

function showResult() {
  stopTimer();
  document.body.classList.add('darken-background');
  const container = document.getElementById('container');
  container.innerHTML = '';

  const percent = Math.round((score / questions.length) * 100);
  const resultText = document.createElement('div');
  resultText.style.fontWeight = 'bold';
  resultText.style.fontSize = '1.3em';
  resultText.textContent = 'æ­£ç­”ç‡: ' + percent + '% (' + score + ' / ' + questions.length + ')';
  container.appendChild(resultText);

if (percent <= 50) {
  document.body.classList.add('darken-background');
} else {
  document.body.classList.remove('darken-background');
}


  if (percent >= 90) {
    // æ¡œãŒé™ã‚Šç¶šã‘ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
    const sakuraInterval = setInterval(() => {
      const sakura = document.createElement('div');
      sakura.className = 'sakura';
      sakura.textContent = 'ğŸŒ¸';
      sakura.style.left = Math.random() * 100 + 'vw';
      sakura.style.animationDuration = (8 + Math.random() * 8) + 's';
      sakura.style.fontSize = (16 + Math.random() * 24) + 'px';
      document.body.appendChild(sakura);
    }, 800);

    // æ¡œã‚’å‰Šé™¤ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è§£é™¤é–¢æ•°
    const removeSakura = () => {
      document.querySelectorAll('.sakura').forEach(el => el.remove());
      clearInterval(sakuraInterval);
    };

    const restartBtn = createButton('ã•ã„ã—ã‚‡ã«ã‚‚ã©ã‚‹', () => {
      removeSakura();
      showCategories();
    });
    container.appendChild(restartBtn);
  } else {
    const restartBtn = createButton('ã‚‚ã†ã„ã£ã‹ã„', showCategories);
    container.appendChild(restartBtn);
  }
}

window.onload = function() {
  showCategories();
};
</script>

</body>
</html>
