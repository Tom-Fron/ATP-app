<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#FFEFD5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
  body { font-family: sans-serif; background: #FFEFD5; text-align: center; padding: 10px 5px;   
position: relative;  }
 .category-btn {
  padding: 14px 20px;
  font-size: 1.2em;
  margin: 10px auto;
  width: 92vw;
  max-width: 340px;
  background-color: orange;
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  white-space: pre-line;
  display: block;
  box-sizing: border-box;
  line-height: 1.4;
  text-align: center;
}
#terms-ja div, #terms-th div {
  margin-top: 0 !important;
  margin-bottom: 0 !important;
  padding-top: 0 !important;
  padding-bottom: 0 !important;
  line-height: 1.4 !important;
  display: flex !important;
  align-items: flex-start !important;
  overflow-wrap: break-word;
  word-break: break-word;
}
#terms-ja div span, #terms-th div span {
  margin: 0 !important;
  padding: 0 0 0 1em !important;
  line-height: 1.4 !important;
  white-space: normal !important;
}
#terms-ja p.hang-indent, #terms-th p.hang-indent {
  text-indent: 0;
  padding-left: 1.5em;
  line-height: 1.5;
  margin: 0;
  white-space: normal;
}
body.darken-background {
    background-color: #2b2b2b !important;
    background-image:
    repeating-linear-gradient(45deg, rgba(255,255,255,0.015) 0, rgba(255,255,255,0.015) 1px, transparent 1px, transparent 5px),
    repeating-linear-gradient(-45deg, rgba(255,255,255,0.015) 0, rgba(255,255,255,0.015) 1px, transparent 1px, transparent 5px);
  color: white !important;
}
  .category-title {
  background-color: #00ff00;
  color: black;
  padding: 8px 16px;
  border-radius: 12px;
  display: inline-block;
  line-height: 1.3;
  white-space: pre-line;
  margin-bottom: 12px;
  user-select: none;
}
  .choice {
  display: block;
  margin: 8px auto;
  padding: 14px 16px;
  padding-right: 40px;
  font-size: 1.2em;
  max-width: 90vw;
  background-color: #ADD8E6;
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  white-space: pre-wrap;
  text-align: left;
  word-break: break-word;
  box-sizing: border-box;
  text-indent: 0;
}
.choice {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}
.choice .thai {
  margin-top: 4px;
  font-size: 1.1em;
  color: #003366;
}
  .choice.disabled:hover,
  .choice.disabled:active {
    background-color: #ADD8E6 !important;
  }
  .chosen { background-color: #87b4cc; }
  .disabled { pointer-events: none; }
  .mark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2em;
    font-weight: bold;
    color: red;
    user-select: none;
    pointer-events: none;
  }
  .speaker-icon {
    cursor: pointer;
    font-size: 1.5em;
    color: #444;
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    user-select: none;
    pointer-events: auto;
  }
  .explanation {
    margin-top: 20px;
    white-space: pre-wrap;
    color: #444;
    text-align: left;
    max-width: 90vw;
    margin-left: auto;
    margin-right: auto;
  }
  .next-btn {
    width: 100px; 
    margin: 20px auto;
    display: block;
  }
  #container {
    position: relative;
    padding-bottom: 80px;
  }
  body {
    position: relative;
  }
  @keyframes fall {
    0% { transform: translateY(-50px) rotate(0deg); opacity: 0.8; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
  }
  .sakura {
    position: fixed;
    top: -80px;
    font-size: 24px;
    pointer-events: none;
    color: pink;
    animation: fall linear 12s;
    z-index: 9999;
    user-select: none;
  }
  #header {
    display: flex !important;
    flex-direction: column !important;
    align-items: center;
    text-align: center !important;
  }
  #header > img#logo {
    display: block;
    margin: 0 auto 0px;
    width: 250px;
    height: auto;
  }
  #main-title {
    margin-top: 0;
    margin-bottom: 0;
    text-align: center;
  }
  #terms-ja div, #terms-th div {
    display: flex !important;
    align-items: flex-start !important;
    line-height: 1.4 !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow-wrap: break-word;
    word-break: break-word;
  }
  #terms-ja p.hang-indent, #terms-th p.hang-indent {
    display: flex;
    margin: 0;
    padding-left: 1.5em;
    line-height: 1.5;
    white-space: normal;
    overflow-wrap: break-word;
    word-break: break-word;
  }
  #terms-ja p.hang-indent span.number, #terms-th p.hang-indent span.number {
    flex-shrink: 0;
    margin: 0;
    padding: 0;
    white-space: nowrap;
  }
  #terms-ja p.hang-indent span.text, #terms-th p.hang-indent span.text {
    margin-left: 0;
    white-space: normal;
    overflow-wrap: break-word;
    word-break: break-word;
  }
</style>

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DS9KC8SGP0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DS9KC8SGP0');
</script>

<script>
  window.addEventListener('beforeinstallprompt', (e) => {
    window.deferredPrompt = e;
  });

  window.addEventListener('appinstalled', (event) => {
    console.log('PWAãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸ');

    if (typeof gtag === 'function') {
      gtag('event', 'pwa_install', {
        event_category: 'engagement',
        event_label: 'PWAãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸ'
      });
    }
  });
</script>

</head>
<body>
<div id="header">
<img src="logo.png" alt="ATP ãƒ­ã‚´" id="logo"/>
<h1 id="main-title">ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤</h1>
</div>
<div id="start-buttons"></div>
<div style="text-align:center; margin-top: 10px;">
<span id="read-terms" style="cursor:pointer; font-size: 0.9em; color: blue; text-decoration: underline;">
  à¸à¸£à¸¸à¸“à¸²à¸­à¹ˆà¸²à¸™à¸à¹ˆà¸­à¸™à¹ƒà¸Šà¹‰à¸‡à¸²à¸™<br>ã¯ã˜ã‚ã«èª­ã‚“ã§ãã ã•ã„
</span>
</div>
<div id="category-buttons"></div>
<div id="terms-container"
  style="
    display: none;
    background: white;
    margin: 0 auto;
    padding: 20px 16px 20px 16px;
    width: calc(100vw - 32px);
    max-width: 600px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    box-sizing: border-box;
    overflow-wrap: break-word;
    overflow-x: hidden;
    word-break: break-word;
  ">
  <div id="terms-th" style="margin: 0; padding: 0; text-align: left;"></div>
  <hr>
  <div id="terms-ja" style="margin: 0; padding: 0; text-align: left;"></div>
  <!--ã€Œà¸›à¸´à¸”ã€ãƒœã‚¿ãƒ³ -->
  <div style="text-align: center; margin-top: 30px;">
  <button id="back-button" style="font-size: 1em; padding: 8px 16px; background-color: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer;">à¸›à¸´à¸”</button>
  </div>
</div>
<div id="container"></div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    window.location.reload();
  });
}

// JSONãƒ‡ãƒ¼ã‚¿ã¯ã“ã“ã«Pythonã‹ã‚‰å·®ã—è¾¼ã‚€
let audioPlaying = null;
let allQuestions = {};

fetch("./questions.json")
  .then(res => res.json())
  .then(data => {
    allQuestions = data;
    showCategories();
  })
  .catch(err => {
    console.error("âŒ questions.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
    alert("å•é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
  });

function getAudioSrc(filename) {
  return `tts_audio/${filename}`;  // ä¾‹: audio/1-01-1.mp3
}

let currentCategory = null;
let questions = [];
let currentIndex = 0;
let score = 0;
let timerInterval = null;
let answered = false;

function createButton(text, onClick) {
  const btn = document.createElement('button');
  btn.textContent = text;
  btn.className = 'category-btn';
  btn.onclick = onClick;
  return btn;
}

function showCategories() {
  document.body.classList.remove('darken-background');
  const container = document.getElementById('start-buttons');
  container.style.display = 'block';
  container.innerHTML = '';
  
  const title = document.getElementById('main-title');
  title.textContent = 'ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤';
  title.classList.remove('category-title');
  title.style.color = '';

const keys = Object.keys(allQuestions);

const category1 = keys[0];
const category2 = keys[1];

if (category1) {
  const count1 = allQuestions[category1].length;
  const [jp1, th1] = category1.split('\n');
  const btn1 = createButton(`${jp1}ï¼ˆ${count1}å•ï¼‰\n${th1}`, () => startQuiz(category1));
  container.appendChild(btn1);
}

if (category2) {
  const count2 = allQuestions[category2].length;
  const [jp2, th2] = category2.split('\n');
  const btn2 = createButton(`${jp2}ï¼ˆ${count2}å•ï¼‰\n${th2}`, () => startQuiz(category2));
  container.appendChild(btn2);
}

  document.getElementById('read-terms').style.display = 'block';
  document.getElementById('container').innerHTML = '';
}

function startQuiz(category) {
  document.getElementById('read-terms').style.display = 'none';
  document.getElementById('terms-container').style.display = 'none';
  currentCategory = category;
  questions = [...allQuestions[category]].sort(() => Math.random() - 0.5);
  currentIndex = 0;
  score = 0;
  const [jp, th] = category.split('\n');
  const title = document.getElementById('main-title');
  title.innerHTML = `${jp}<br>${th}`; 
  title.classList.add('category-title');    document.getElementById('start-buttons').style.display = 'none';
  showQuestion();
}

function showQuestion() {
  answered = false;
  if (audioPlaying) {
    audioPlaying.pause();
    audioPlaying.currentTime = 0;
    audioPlaying = null;
  }
  answered = false;
  const q = questions[currentIndex];
  const container = document.getElementById('container');
  container.innerHTML = '';
  const progress = document.createElement('div');
  progress.textContent = `${currentIndex + 1} / ${questions.length}`;
  progress.style.fontWeight = 'bold';
  progress.style.textAlign = 'left';
  progress.style.marginBottom = '10px';
  container.appendChild(progress);
  const qElem = document.createElement('div');
  const highlighted = q.question
    .replace(/ï¼ˆæ­£ç­”\dã¤ï¼‰/g, m => `<span style="color:red;">${m}</span>`)
    .replace(/[ï¼ˆ(]à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\dà¸‚à¹‰à¸­[)ï¼‰]/g, m => `<span style="color:red;">${m}</span>`);
  qElem.innerHTML = highlighted;
  qElem.style.whiteSpace = 'pre-wrap';
  qElem.style.fontWeight = 'bold';
  qElem.style.fontSize = '1.2em';
  qElem.style.textAlign = 'left';
  container.appendChild(qElem);

   let selectedChoices = [];

  const shuffledChoices = [...q.choices].sort(() => Math.random() - 0.5);
 shuffledChoices.forEach(choice => {
  const choiceDiv = document.createElement('div');
  choiceDiv.className = 'choice';
  choiceDiv.textContent = choice;
  choiceDiv.style.textAlign = 'left';
  choiceDiv.onclick = () => {
    if (answered) return;
    const alreadySelected = selectedChoices.includes(choice);

    if (alreadySelected) {
      selectedChoices = selectedChoices.filter(c => c !== choice);
      choiceDiv.classList.remove('chosen');
    } else {
      selectedChoices.push(choice);
      choiceDiv.classList.add('chosen');
    }

    if (selectedChoices.length === q.correct.length) {
      answered = true;
      container.classList.add('disabled');

      container.querySelectorAll('.choice').forEach(choiceDiv => {
        choiceDiv.style.cursor = 'default';
      });

      container.querySelectorAll('.speaker-icon').forEach(speaker => {
        speaker.style.cursor = 'pointer';
      });

      let isAllCorrect = true;

    selectedChoices.forEach(sel => {
  const choiceElement = Array.from(container.getElementsByClassName('choice'))
    .find(div => div.textContent === sel);
  if (!choiceElement) return;

  const isCorrect = q.correct.some(c => c.jp === sel);
  if (!isCorrect) isAllCorrect = false;

  markChoice(choiceElement, isCorrect);

  if (isCorrect) {
    const correctIndex = q.correct.findIndex(c => c.jp === sel) + 1;
    const numberStr = String(q.number).padStart(2, '0');
    const audioFileName = `${q.categoryNo}-${numberStr}-${correctIndex}.mp3`;
    const audioSrc = `tts_audio/${audioFileName}`;

    const speaker = document.createElement('span');
    speaker.className = 'speaker-icon';
    speaker.innerHTML = 'ğŸ”Š';
    speaker.onclick = e => {
      e.stopPropagation();
      if (audioPlaying) {
        audioPlaying.pause();
        audioPlaying.currentTime = 0;
      }
      const audio = new Audio(audioSrc);
      audio.playbackRate = 1.3;
      audio.play();
      audioPlaying = audio;
      audio.onended = () => {
        audioPlaying = null;
      };
    };
   const correctObj = q.correct.find(c => c.jp === sel);
if (correctObj && correctObj.th) {
  const thElem = document.createElement('div');
  thElem.textContent = correctObj.th;
  thElem.style.marginTop = '4px';
  thElem.style.fontSize = '1.1em';
  thElem.style.color = '#003366';

  const wrapper = document.createElement('div');
  wrapper.style.marginTop = '6px';
  wrapper.appendChild(speaker);
  wrapper.appendChild(thElem);

  choiceElement.appendChild(wrapper);
} else {
  choiceElement.appendChild(speaker);
     }
   }
 });

q.correct.forEach(correctAns => {
  if (!selectedChoices.includes(correctAns.jp)) {
    const choiceElement = Array.from(container.getElementsByClassName('choice'))
      .find(div => div.textContent === correctAns.jp);
    if (choiceElement) {
      choiceElement.style.backgroundColor = '#ffccff';
      const correctIndex = q.correct.findIndex(c => c.jp === correctAns.jp) + 1;
      const numberStr = String(q.number).padStart(2, '0');
      const audioFileName = `${q.categoryNo}-${numberStr}-${correctIndex}.mp3`;
      const audioSrc = `tts_audio/${audioFileName}`;
      const speaker = document.createElement('span');
      speaker.className = 'speaker-icon';
      speaker.innerHTML = 'ğŸ”Š';
      speaker.onclick = e => {
        e.stopPropagation();
        if (audioPlaying) {
          audioPlaying.pause();
          audioPlaying.currentTime = 0;
        }
        const audio = new Audio(audioSrc);
        audio.playbackRate = 1.3;
        audio.play();
        audioPlaying = audio;
        audio.onended = () => {
          audioPlaying = null;
        };
      };
      choiceElement.appendChild(speaker);

      if (correctAns.th) {
        const thElem = document.createElement('div');
        thElem.textContent = correctAns.th;
        thElem.style.marginTop = '4px';
        thElem.style.fontSize = '1.1em';
        thElem.style.color = '#003366';
        choiceElement.appendChild(thElem);
      }
    }
  }
});

      if (isAllCorrect) {
        score++;
      }

      showExplanation();
    }
  };
    container.appendChild(choiceDiv);
  });
}

function markChoice(choiceDiv, isCorrect) {
  const mark = document.createElement('span');
  mark.className = 'mark';
  mark.textContent = isCorrect ? 'ã€‡' : 'Ã—';
  choiceDiv.appendChild(mark);
}

function showExplanation() {
  const container = document.getElementById('container');
  const q = questions[currentIndex];

if (q.explanation && q.explanation.trim() !== '') {
  const explanationDiv = document.createElement('div');
  explanationDiv.className = 'explanation';
  explanationDiv.textContent = q.explanation;
  container.appendChild(explanationDiv);
}
  const existingNextBtn = container.querySelector('.next-btn');
  if (existingNextBtn) {
    existingNextBtn.remove();
  }
  const nextBtn = createButton('ã¤ãã¸', () => {
    currentIndex++;
    if (currentIndex < questions.length) {
      showQuestion();
    } else {
      showResult();
    }
  });
  nextBtn.classList.add('next-btn'); 
  container.appendChild(nextBtn);

  container.classList.remove('disabled');
}

function showResult() {
  let sakuraInterval; 
  document.body.classList.add('darken-background');
  const container = document.getElementById('container');
  container.innerHTML = '';

  const percent = Math.round((score / questions.length) * 100);
const resultText = document.createElement('div');
resultText.style.fontWeight = 'bold';
resultText.style.fontSize = '1.3em';
resultText.style.marginTop = '20px'; 
resultText.style.marginBottom = '20px'; 
resultText.textContent = `æ­£ç­”æ•° ${score} / ${questions.length}å•ï¼ˆ${percent}%ï¼‰`;
container.appendChild(resultText);

if (percent < 50) {
  document.body.classList.add('darken-background');
} else {
  document.body.classList.remove('darken-background');
}

if (percent >= 90) {
  const createSakura = () => {
    const sakura = document.createElement('div');
    sakura.className = 'sakura';
    sakura.textContent = 'ğŸŒ¸';
    sakura.style.left = Math.random() * 100 + 'vw';
    sakura.style.animationDuration = (8 + Math.random() * 8) + 's';
    sakura.style.fontSize = (16 + Math.random() * 24) + 'px';
    document.body.appendChild(sakura);
  };

  setTimeout(() => {
    createSakura();
    sakuraInterval = setInterval(createSakura, 800);
  }, 0);
}

const restartBtn = createButton('ã‚‚ã†ã„ã¡ã©', () => {
  if (percent >= 90) {
    document.querySelectorAll('.sakura').forEach(el => el.remove());
    clearInterval(sakuraInterval);
  }
  showCategories();
});
restartBtn.style.width = '200px';
container.appendChild(restartBtn);
}

 document.addEventListener('DOMContentLoaded', () => {
  showCategories();
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('Service Worker registered'))
      .catch(err => console.error('Service Worker registration failed:', err));
  }

  const readTerms = document.getElementById('read-terms');
  const backButton = document.getElementById('back-button');
  const categoryButtons = document.getElementById('category-buttons');

  if (readTerms) {
    readTerms.addEventListener('click', () => {
      fetch('terms.json')
        .then(response => response.json())
        .then(data => {
          if (categoryButtons) categoryButtons.style.display = 'none';
          readTerms.style.display = 'none';
          document.getElementById('terms-container').style.display = 'block';

 const formatLine = (line) => {
 const isHeading = /^[0-9]+[.ï¼]/.test(line);
  const isSubList = /^([0-9]+ï¼‰)(.+)/.exec(line);
  const isNote = /^(â€»)(.+)/.exec(line);

  if (isSubList) {
    return `
      <p class="hang-indent">
        <span class="number" style="padding-left: 1em;">${isSubList[1]}</span><span class="text">${isSubList[2]}</span>
      </p>`;
  } else if (isNote) {
    return `
      <p class="hang-indent">
        <span class="number" style="padding-left: 1em;">${isNote[1]}</span><span class="text">${isNote[2]}</span>
      </p>`;
  } else if (isHeading) {
    return `<p class="hang-indent" style="font-weight: bold; margin-top: 1em;">${line}</p>`;
  } else {
    return `
      <p class="hang-indent">
        <span class="number" style="padding-left: 1em;"></span><span class="text">${line}</span>
      </p>`;
  }
};

         document.getElementById('terms-th').innerHTML = data.th.map(formatLine).join('');

          document.getElementById('terms-ja').innerHTML = data.ja.map(formatLine).join('');
        });
    });
  }

  if (backButton) {
    backButton.addEventListener('click', () => {
      document.getElementById('terms-container').style.display = 'none';
      document.getElementById('category-buttons').style.display = 'block';
      readTerms.style.display = 'block';
    });
  }
});
</script>

<footer id="footer" style="text-align:center; padding:10px; font-size:0.8em; color:#666;">
  Â©2026 Thai Asawalert Manpower Co., Ltd.
</footer>
</body>
</html>